name: Android CI/CD - Build, Sign & Release

on:
  # Triggers the workflow on push events but only for the main branch
  push:
    branches: [ main ]
    
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    # NEW: Inputs for manual runs
    inputs:
      bump_type:
        description: 'Type of version bump (default: patch)'
        type: choice
        options: ['patch', 'minor', 'major']
        default: 'patch'
      specific_version:
        description: 'Set a specific version (e.g., 26.0.0). Overrides bump_type.'
        type: string
        required: false

# NEW: Add permissions for the job to commit version changes back to the repo
permissions:
  contents: write

jobs:
  build-and-release:
    name: Build, Sign & Release to Play Store
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        # We need to fetch all history to push changes back
        with:
          fetch-depth: 0 

      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: 3. Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # NEW STEP 4: Handle Version Bumping
      # This step runs *before* the build to modify the gradle file.
      - name: 4. Bump version using specific_version (if provided)
        # This step only runs if you filled in the 'specific_version' input
        if: github.event.inputs.specific_version != ''
        id: version_bump_specific
        uses: chkfung/android-version-actions@v1.2.3
        with:
          # IMPORTANT: Verify this path is correct for your project
          gradleFilePath: app/build.gradle
          versionName: ${{ github.event.inputs.specific_version }}
          versionCodeIncrement: 1 # Always increment versionCode

      - name: 4. Bump version by type (patch/minor/major)
        # This step only runs if you did NOT provide a 'specific_version'
        if: github.event.inputs.specific_version == '' 
        id: version_bump_auto
        uses: chkfung/android-version-actions@v1.2.3
        with:
          # IMPORTANT: Verify this path is correct for your project
          gradleFilePath: app/build.gradle
          # Use the manual 'bump_type' input OR default to 'patch' for push events
          versionNameIncrementType: ${{ (github.event_name == 'workflow_dispatch') && github.event.inputs.bump_type || 'patch' }}
          versionCodeIncrement: 1 # Always increment versionCode

      - name: 5. Inject API Key into local.properties
        run: |
          echo "API_KEY=${{ secrets.API_KEY }}" > ./local.properties
        
      - name: 6. Decode and setup Keystore
        run: |
          echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > ${{ github.workspace }}/app/release-keystore.jks

      - name: 7. Build and Sign App Bundle
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        run: ./gradlew bundleRelease

      - name: 8. Upload to Internal Testing Track on Google Play
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.app.bmeapplication1
          track: internal
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          # whatsNewDirectory: app/src/main/play/release-notes/
          
      # NEW STEP 9: Commit and Push Version Bump
      # This saves the new version back to your 'main' branch
      - name: 9. Commit and Push Version Bump
        run: |
          # Read the new version name directly from the file
          NEW_VERSION_NAME=$(grep "versionName " app/build.gradle | awk '{print $2}' | tr -d '"')
          
          # Configure Git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add the modified file
          # IMPORTANT: Verify this path is correct
          git add app/build.gradle
          
          # Commit the change
          # [skip ci] prevents this commit from triggering the workflow again
          git commit -m "ci: Bump version to $NEW_VERSION_NAME [skip ci]"
          
          # Push the change back to the main branch
          git push
